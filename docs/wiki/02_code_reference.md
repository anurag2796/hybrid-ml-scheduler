# 02. Code Reference

This document provides a walk-through of the main classes, functions, and data structures.

## Core Simulation Classes

### `VirtualMultiGPU` (`src/simulator.py`)
This is the "physics engine" representing a high-end compute node.
* **Host CPU**: Executing tasks with a base speed of `1.0x`. Memory boundaries and OS overhead are simulated here.
* **Virtual GPUs (4 Units)**: Acting as physical accelerators. Tasks can experience a speedup of up to `4x`. 
* **Interconnect simulation**: Simulates PCIe Gen 3 (16GB/s). Task latency incorporates transfer time (`Size / Bandwidth`).

### `ContinuousSimulation` (`src/simulation_engine.py`)
The orchestrator managing the scheduler loop.
* **`start()`**: Async method driving the task generation and broadcast loop.
* **`_run_all_schedulers(task)`**: Distributes the given `task` to RR, Random, Greedy, Hybrid ML, RL, and Oracle simulators, collecting actual time simulated.
* **`_calculate_metrics(result)`**: Transforms execution time and GPU fraction into Joules and Dollars based on modeled GPU (50W, $0.0001/s) and CPU (30W, $0.00002/s) models.

### `WorkloadGenerator` (`src/workload_generator.py`)
Generates tasks.
* **`Task` Data Class**: Stores properties for `task_id`, `size`, `compute_intensity`, and `memory_required`.

## AI/ML Components

### `OfflineTrainer` (`src/offline_trainer.py` / `src/ml_models.py`)
Trains the supervised Hybrid ML model (Random Forest / XGBoost) on historical data generated by the WorkloadGenerator paired with Oracle brute-force best results. Uses `StandardScaler` to normalize input task feature vectors `[Size, Intensity, Memory]`.

### `DQNScheduler` (`src/dqn_scheduler.py`)
The PyTorch-based Reinforcement Learning Agent.
* **`get_action(task)`**: Implements Epsilon-Greedy logic. Flips a coin to either explore (random action) or exploit (forward pass through `DQN` class).
* **`observe(task, action, reward_metrics)`**: Allows the agent to populate its Experience Replay memory buffer. Calculates a scalar reward based on cost/energy parameters.
* **`DQN` Neural Net**: 3 input neurons, 2 hidden layers (256 neurons each), and 5 output neurons representing Q-values for CPU and GPUs 0-3.

## Pydantic Schemas (`backend/models/schemas.py`)
* **`TaskCreate`**: Validates `task_id` (int), `size` (float), `compute_intensity` (float, 0.0-1.0), and `memory` (float).
* **`SchedulerResultCreate`**: Validates simulated outcomes (`gpu_fraction` float, `actual_time` float).
